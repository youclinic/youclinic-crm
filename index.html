// Updated React CRM App with patient detail toggle, file upload, tab switch behavior fix, and refined styling

import React, { useState } from "react";
import "./App.css";

function App() {
  const [patients, setPatients] = useState([]);
  const [selectedPatient, setSelectedPatient] = useState(null);
  const [section, setSection] = useState("patients");
  const [searchTerm, setSearchTerm] = useState("");

  const addPatient = () => {
    const name = prompt("Enter patient name");
    const age = prompt("Enter child age");
    const phone = prompt("Enter phone number");
    const responsible = prompt("Enter responsible name");

    const newPatient = {
      name,
      age,
      phone,
      responsible,
      createdAt: new Date().toLocaleString(),
      acceptedAt: new Date().toLocaleString(),
      stage: "new",
      file: null,
      notes: "",
    };

    setPatients([...patients, newPatient]);
    setSelectedPatient(null);
  };

  const updatePatientStage = (patient, newStage) => {
    const updatedPatients = patients.map((p) =>
      p === patient ? { ...p, stage: newStage } : p
    );
    setPatients(updatedPatients);
    setSelectedPatient(null);
  };

  const handlePatientClick = (patient) => {
    if (selectedPatient === patient) {
      setSelectedPatient(null);
    } else {
      setSelectedPatient(patient);
    }
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    const updatedPatients = patients.map((p) =>
      p === selectedPatient ? { ...p, file } : p
    );
    setPatients(updatedPatients);
  };

  const handleNoteChange = (e) => {
    const updatedPatients = patients.map((p) =>
      p === selectedPatient ? { ...p, notes: e.target.value } : p
    );
    setPatients(updatedPatients);
  };

  const filteredPatients = patients.filter(
    (p) =>
      p.stage === section &&
      p.name.toLowerCase().includes(searchTerm.toLowerCase())
  );

  return (
    <div className="app">
      <aside className="sidebar">
        <img src="/logo.png" alt="Logo" className="logo" />
        <h2>YOU CLINIC CRM</h2>
        <nav>
          <button onClick={() => setSection("new")}>Patients</button>
          <button onClick={() => setSection("sold")}>Solds</button>
          <button onClick={() => setSection("aftercare")}>Aftercare</button>
        </nav>
      </aside>
      <main>
        <header className="topbar">
          <input
            type="text"
            placeholder="Search by name..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
          />
          <button className="add-button" onClick={addPatient}>
            Add Patient
          </button>
        </header>
        <div className="table">
          <div className="table-header">
            <div>Name</div>
            <div>Age</div>
            <div>Phone</div>
            <div>Responsible</div>
          </div>
          {filteredPatients.map((patient, idx) => (
            <div
              key={idx}
              className="table-row"
              onClick={() => handlePatientClick(patient)}
            >
              <div>{patient.name}</div>
              <div>{patient.age}</div>
              <div>{patient.phone}</div>
              <div>{patient.responsible}</div>
            </div>
          ))}
        </div>

        {selectedPatient && section === selectedPatient.stage && (
          <div className="profile">
            <h3>Patient Profile</h3>
            <p><strong>Name:</strong> {selectedPatient.name}</p>
            <p><strong>Child Age:</strong> {selectedPatient.age}</p>
            <p><strong>Phone:</strong> {selectedPatient.phone}</p>
            <p><strong>Responsible:</strong> {selectedPatient.responsible}</p>
            <p><strong>Created:</strong> {selectedPatient.createdAt}</p>
            <p><strong>Accepted:</strong> {selectedPatient.acceptedAt}</p>

            <textarea
              placeholder="Write your notes here..."
              value={selectedPatient.notes}
              onChange={handleNoteChange}
            />

            <input type="file" onChange={handleFileChange} />

            {selectedPatient.stage === "new" && (
              <button onClick={() => updatePatientStage(selectedPatient, "sold")}>
                Mark as Sold
              </button>
            )}
            {selectedPatient.stage === "sold" && (
              <button onClick={() => updatePatientStage(selectedPatient, "aftercare")}>
                Treatment Done
              </button>
            )}
          </div>
        )}
      </main>
    </div>
  );
}

export default App;
